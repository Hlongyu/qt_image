ARG BASE_IMAGE=qt-buildenv
ARG BASE_VERSION=latest

FROM ${BASE_IMAGE}:${BASE_VERSION} AS build

ARG QT_VERSION=6.8.3
ARG QT_SUBMODULES=qtbase,qtimageformats,qthttpserver,qttranslations
ARG QT_TARBALL_URL=

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends wget xz-utils; \
    rm -rf /var/lib/apt/lists/*; \
    series="${QT_VERSION%.*}"; \
    if [[ -n "${QT_TARBALL_URL}" ]]; then \
      url="${QT_TARBALL_URL}"; \
    else \
      url="https://download.qt.io/archive/qt/${series}/${QT_VERSION}/single/qt-everywhere-src-${QT_VERSION}.tar.xz"; \
    fi; \
    mkdir -p /qt-src; \
    wget -qO /tmp/qt-src.tar.xz "${url}"; \
    tar -xf /tmp/qt-src.tar.xz -C /qt-src; \
    rm -f /tmp/qt-src.tar.xz; \
    test -d "/qt-src/qt-everywhere-src-${QT_VERSION}"

WORKDIR /qt-src/qt-everywhere-src-${QT_VERSION}/build

RUN set -eux; \
    common_args=( \
      -opensource \
      -confirm-license \
      -prefix "/opt/qt/${QT_VERSION}" \
      -opengl es2 \
      -ssl \
      -cmake-generator Ninja \
    ); \
    if ../configure -submodules "${QT_SUBMODULES}" "${common_args[@]}"; then \
      :; \
    else \
      ../configure "${common_args[@]}"; \
    fi; \
    cat config.summary;\
    cmake --build . --parallel; \
    cmake --install .

FROM ${BASE_IMAGE}:${BASE_VERSION} AS final

ARG QT_VERSION=6.8.3

COPY --from=build /opt/qt/${QT_VERSION} /opt/qt/${QT_VERSION}

ENV QT_ROOT=/opt/qt/${QT_VERSION}
ENV PATH=/opt/qt/${QT_VERSION}/bin:$PATH

WORKDIR /work
CMD ["/bin/bash"]
